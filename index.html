<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Piscinas</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .nav { display: flex; gap: 10px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap; }
        .nav-btn { padding: 12px 24px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .nav-btn:hover, .nav-btn.active { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
        .section { display: none; background: rgba(255,255,255,0.95); border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .section.active { display: block; }
        .form-grid { display: grid; gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-weight: bold; color: #333; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { border-color: #667eea; outline: none; }
        .btn { padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); }
        .btn-success { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .btn-small { padding: 6px 12px; font-size: 12px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; }
        .stat-number { font-size: 28px; font-weight: bold; margin-bottom: 5px; }
        .table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .table th { background: #f8f9fa; font-weight: bold; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-top: 20px; }
        .calendar-header { background: #667eea; color: white; padding: 10px; text-align: center; font-weight: bold; }
        .calendar-day { background: white; border: 1px solid #ddd; min-height: 80px; padding: 5px; position: relative; cursor: pointer; }
        .calendar-day.today { background: #e3f2fd; }
        .calendar-day.has-event { background: #f0f8ff; }
        .day-schedule {
    min-height: 200px;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    background: #f9f9f9;
}

.schedule-item {
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 10px;
    cursor: pointer;
}

.schedule-item:hover {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.day-column {
    display: flex;
    flex-direction: column;
}
        .event { background: #667eea; color: white; font-size: 10px; padding: 2px 4px; margin: 1px 0; border-radius: 3px; }
        .debt-card { background: linear-gradient(135deg, #ff7675 0%, #d63031 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .debt-paid { background: linear-gradient(135deg, #00b894 0%, #00a085 100%); }
        .multi-sale-container { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .sale-item { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .items-container { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
        .item-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 5% auto; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 80%; overflow-y: auto; }
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .nav { flex-direction: column; }
            .container { padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèä‚Äç‚ôÇÔ∏è Sistema de Gesti√≥n de Piscinas</h1>
            <p>Gesti√≥n completa con ventas m√∫ltiples simult√°neas</p>
        </div>

        <div class="nav">
            <button class="nav-btn active" onclick="showSection('dashboard')">üìä Dashboard</button>
            <button class="nav-btn" onclick="showSection('clients')">üë• Clientes</button>
            <button class="nav-btn" onclick="showSection('products')">üì¶ Productos</button>
            <button class="nav-btn" onclick="showSection('services')">üîß Servicios</button>
            <button class="nav-btn" onclick="showSection('sales')">üí∞ Ventas</button>
            <button class="nav-btn" onclick="showSection('multi-sales')">üõí Ventas M√∫ltiples</button>
            <button class="nav-btn" onclick="showSection('debts')">üí≥ Deudas</button>
            <button class="nav-btn" onclick="showSection('calendar')">üìÖ Calendario</button>
            <button class="nav-btn" onclick="showSection('schedule')">üìã Programar Visitas</button>
            <button class="nav-btn" onclick="exportToExcel()">üìÑ Exportar</button>
<button class="nav-btn" onclick="document.getElementById('importFile').click()">üì• Importar</button>
<input type="file" id="importFile" accept=".xlsx,.xls" style="display: none;" onchange="importFromExcel(event)">
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalClients">0</div>
                    <div>Clientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalProducts">0</div>
                    <div>Productos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalServices">0</div>
                    <div>Servicios</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSales">$0</div>
                    <div>Ventas del Mes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalDebts">$0</div>
                    <div>Deudas Pendientes</div>
                </div>
            </div>
        </div>

        <!-- Clientes -->
        <div id="clients" class="section">
            <div class="card">
                <div class="card-header">‚ûï Agregar Cliente</div>
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                    <div class="form-group">
                        <label>Nombre:</label>
                        <input type="text" id="clientName" placeholder="Nombre del cliente">
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono:</label>
                        <input type="text" id="clientPhone" placeholder="Tel√©fono">
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="clientEmail" placeholder="Email">
                    </div>
                    <div class="form-group">
                        <label>Direcci√≥n:</label>
                        <input type="text" id="clientAddress" placeholder="Direcci√≥n">
                    </div>
                </div>
                <button class="btn" onclick="addClient()">Agregar Cliente</button>
            </div>
            <div id="clientsList"></div>
        </div>

        <!-- Productos -->
        <div id="products" class="section">
            <div class="card">
                <div class="card-header">‚ûï Agregar Producto</div>
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="form-group">
                        <label>Nombre:</label>
                        <input type="text" id="productName" placeholder="Nombre del producto">
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a:</label>
                        <select id="productCategory">
                            <option value="">Seleccionar categor√≠a</option>
                            <option value="Qu√≠micos">Qu√≠micos</option>
                            <option value="Equipos">Equipos</option>
                            <option value="Accesorios">Accesorios</option>
                            <option value="Limpieza">Limpieza</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Precio Costo:</label>
                        <input type="number" id="productCostPrice" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Precio Venta:</label>
                        <input type="number" id="productSalePrice" placeholder="0.00" step="0.01">
                    </div>
                </div>
                <button class="btn" onclick="addProduct()">Agregar Producto</button>
            </div>
            <div id="productsList"></div>
        </div>

        <!-- Servicios -->
        <div id="services" class="section">
            <div class="card">
                <div class="card-header">‚ûï Agregar Servicio</div>
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="form-group">
                        <label>Tipo de Servicio:</label>
                        <select id="serviceType">
                            <option value="">Seleccionar tipo</option>
                            <option value="Limpieza">Limpieza</option>
                            <option value="Mantenimiento">Mantenimiento</option>
                            <option value="Reparaci√≥n">Reparaci√≥n</option>
                            <option value="Instalaci√≥n">Instalaci√≥n</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n:</label>
                        <input type="text" id="serviceDescription" placeholder="Descripci√≥n del servicio">
                    </div>
                    <div class="form-group">
                        <label>Duraci√≥n (mins):</label>
                        <input type="number" id="serviceDuration" placeholder="60">
                    </div>
                    <div class="form-group">
                        <label>Precio:</label>
                        <input type="number" id="servicePrice" placeholder="0.00" step="0.01">
                    </div>
                </div>
                <button class="btn" onclick="addService()">Agregar Servicio</button>
            </div>
            <div id="servicesList"></div>
        </div>

        <!-- Ventas M√∫ltiples -->
        <div id="multi-sales" class="section">
            <div class="card">
                <div class="card-header">üõí Registro de Ventas M√∫ltiples</div>
                <div class="multi-sale-container">
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div class="form-group">
                            <label>Fecha:</label>
                            <input type="date" id="multiSaleDate">
                        </div>
                        <div class="form-group">
                            <label>Frecuencia de Pago:</label>
                            <select id="multiPaymentFreq">
                                <option value="diario">Diario</option>
                                <option value="semanal">Semanal</option>
                                <option value="mensual">Mensual</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Observaciones:</label>
                            <input type="text" id="multiSaleNotes" placeholder="Notas generales">
                        </div>
                    </div>
                    <div id="multiSaleItems"></div>
                    <button class="btn" onclick="addMultiSaleItem()">‚ûï Agregar Cliente</button>
                    <button class="btn btn-success" onclick="saveMultiSale()">üíæ Guardar Todas las Ventas</button>
                </div>
            </div>
        </div>

        <!-- Ventas Individuales -->
        <div id="sales" class="section">
            <div class="card">
                <div class="card-header">üí∞ Nueva Venta</div>
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="form-group">
                        <label>Cliente:</label>
                        <select id="saleClient">
                            <option value="">Seleccionar cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo:</label>
                        <select id="saleType" onchange="updateSaleOptions()">
                            <option value="">Seleccionar tipo</option>
                            <option value="producto">Producto</option>
                            <option value="servicio">Servicio</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Item:</label>
                        <select id="saleItem">
                            <option value="">Seleccionar item</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cantidad:</label>
                        <input type="number" id="saleQuantity" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>Fecha:</label>
                        <input type="date" id="saleDate">
                    </div>
                    <div class="form-group">
                        <label>Frecuencia de Pago:</label>
                        <select id="paymentFrequency">
                            <option value="diario">Diario</option>
                            <option value="semanal">Semanal</option>
                            <option value="mensual">Mensual</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="addSale()">Agregar Venta</button>
            </div>
            <div id="salesList"></div>
        </div>

        <!-- Deudas -->
        <div id="debts" class="section">
            <div class="card">
                <div class="card-header">üí≥ Control de Deudas</div>
                <div id="debtsList"></div>
            </div>
        </div>

        <!-- Calendario -->
        <div id="calendar" class="section">
            <div class="card">
                <div class="card-header">üìÖ Calendario de Servicios</div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button class="btn" onclick="previousMonth()">‚Üê Anterior</button>
                    <h3 id="currentMonth">Enero 2025</h3>
                    <button class="btn" onclick="nextMonth()">Siguiente ‚Üí</button>
                </div>
                <div class="calendar" id="calendarGrid"></div>
            </div>
        </div>
    </div>

    <!-- Programar Visitas -->
<div id="schedule" class="section">
    <div class="card">
        <div class="card-header">üìã Programar Visitas Semanales</div>
        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 15px; margin-bottom: 20px;">
            <div class="day-column">
                <h4 style="text-align: center; background: #667eea; color: white; padding: 10px; border-radius: 8px;">Lunes</h4>
                <div id="schedule-monday" class="day-schedule"></div>
                <button class="btn btn-small" onclick="addScheduleItem('monday')" style="width: 100%; margin-top: 10px;">+ Agregar</button>
            </div>
            <div class="day-column">
                <h4 style="text-align: center; background: #667eea; color: white; padding: 10px; border-radius: 8px;">Martes</h4>
                <div id="schedule-tuesday" class="day-schedule"></div>
                <button class="btn btn-small" onclick="addScheduleItem('tuesday')" style="width: 100%; margin-top: 10px;">+ Agregar</button>
            </div>
            <div class="day-column">
                <h4 style="text-align: center; background: #667eea; color: white; padding: 10px; border-radius: 8px;">Mi√©rcoles</h4>
                <div id="schedule-wednesday" class="day-schedule"></div>
                <button class="btn btn-small" onclick="addScheduleItem('wednesday')" style="width: 100%; margin-top: 10px;">+ Agregar</button>
            </div>
            <div class="day-column">
                <h4 style="text-align: center; background: #667eea; color: white; padding: 10px; border-radius: 8px;">Jueves</h4>
                <div id="schedule-thursday" class="day-schedule"></div>
                <button class="btn btn-small" onclick="addScheduleItem('thursday')" style="width: 100%; margin-top: 10px;">+ Agregar</button>
            </div>
            <div class="day-column">
                <h4 style="text-align: center; background: #667eea; color: white; padding: 10px; border-radius: 8px;">Viernes</h4>
                <div id="schedule-friday" class="day-schedule"></div>
                <button class="btn btn-small" onclick="addScheduleItem('friday')" style="width: 100%; margin-top: 10px;">+ Agregar</button>
            </div>
            <div class="day-column">
                <h4 style="text-align: center; background: #667eea; color: white; padding: 10px; border-radius: 8px;">S√°bado</h4>
                <div id="schedule-saturday" class="day-schedule"></div>
                <button class="btn btn-small" onclick="addScheduleItem('saturday')" style="width: 100%; margin-top: 10px;">+ Agregar</button>
            </div>
            <div class="day-column">
                <h4 style="text-align: center; background: #667eea; color: white; padding: 10px; border-radius: 8px;">Domingo</h4>
                <div id="schedule-sunday" class="day-schedule"></div>
                <button class="btn btn-small" onclick="addScheduleItem('sunday')" style="width: 100%; margin-top: 10px;">+ Agregar</button>
            </div>
        </div>
    </div>
</div>

    <!-- Modal para detalles del calendario -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Detalles del Evento</h3>
                <button class="btn btn-danger btn-small" onclick="closeModal()">‚úï</button>
            </div>
            <div id="eventDetails"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let data = {
            clients: JSON.parse(localStorage.getItem('poolClients') || '[]'),
            products: JSON.parse(localStorage.getItem('poolProducts') || '[]'),
            services: JSON.parse(localStorage.getItem('poolServices') || '[]'),
            sales: JSON.parse(localStorage.getItem('poolSales') || '[]'),
            debts: JSON.parse(localStorage.getItem('poolDebts') || '[]')
        };

        let currentDate = new Date();

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('multiSaleDate').value = new Date().toISOString().split('T')[0];
            updateDashboard();
            renderAll();
        });

        // Navegaci√≥n
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
            
            if (sectionId === 'calendar') renderCalendar();
            if (sectionId === 'debts') renderDebts();
        }

        // Guardar datos
        function saveData() {
            localStorage.setItem('poolClients', JSON.stringify(data.clients));
            localStorage.setItem('poolProducts', JSON.stringify(data.products));
            localStorage.setItem('poolServices', JSON.stringify(data.services));
            localStorage.setItem('poolSales', JSON.stringify(data.sales));
            localStorage.setItem('poolDebts', JSON.stringify(data.debts));
            updateDashboard();
        }

        // Clientes
        function addClient() {
            const name = document.getElementById('clientName').value.trim();
            const phone = document.getElementById('clientPhone').value.trim();
            const email = document.getElementById('clientEmail').value.trim();
            const address = document.getElementById('clientAddress').value.trim();

            if (!name) return alert('El nombre es requerido');

            const client = { id: Date.now(), name, phone, email, address };
            data.clients.push(client);
            
            document.getElementById('clientName').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientEmail').value = '';
            document.getElementById('clientAddress').value = '';
            
            saveData();
            renderClients();
            updateClientSelects();
        }

       function renderClients() {
    const html = data.clients.map(client => `
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3>${client.name}</h3>
                    <p>üìû ${client.phone} | ‚úâÔ∏è ${client.email}</p>
                    <p>üìç ${client.address}</p>
                </div>
                <div>
                    <button class="btn btn-small" onclick="editClient(${client.id})" style="margin-right: 10px;">‚úèÔ∏è Editar</button>
                    <button class="btn btn-danger btn-small" onclick="deleteClient(${client.id})">üóëÔ∏è</button>
                </div>
            </div>
        </div>
    `).join('');
    document.getElementById('clientsList').innerHTML = html;
}
        function deleteClient(id) {
            if (confirm('¬øEliminar cliente?')) {
                data.clients = data.clients.filter(c => c.id !== id);
                saveData();
                renderClients();
                updateClientSelects();
            }
        }

        function editClient(id) {
    const client = data.clients.find(c => c.id === id);
    if (!client) return;
    
    document.getElementById('clientName').value = client.name;
    document.getElementById('clientPhone').value = client.phone;
    document.getElementById('clientEmail').value = client.email;
    document.getElementById('clientAddress').value = client.address;
    
    // Cambiar el bot√≥n temporalmente
    const addBtn = document.querySelector('#clients .btn');
    addBtn.textContent = 'Actualizar Cliente';
    addBtn.onclick = () => updateClient(id);
}

function updateClient(id) {
    const name = document.getElementById('clientName').value.trim();
    const phone = document.getElementById('clientPhone').value.trim();
    const email = document.getElementById('clientEmail').value.trim();
    const address = document.getElementById('clientAddress').value.trim();

    if (!name) return alert('El nombre es requerido');

    const clientIndex = data.clients.findIndex(c => c.id === id);
    if (clientIndex !== -1) {
        data.clients[clientIndex] = { id, name, phone, email, address };
        
        // Limpiar formulario
        document.getElementById('clientName').value = '';
        document.getElementById('clientPhone').value = '';
        document.getElementById('clientEmail').value = '';
        document.getElementById('clientAddress').value = '';
        
        // Restaurar bot√≥n
        const addBtn = document.querySelector('#clients .btn');
        addBtn.textContent = 'Agregar Cliente';
        addBtn.onclick = addClient;
        
        saveData();
        renderClients();
        updateClientSelects();
    }
}

        // Productos
        function addProduct() {
            const name = document.getElementById('productName').value.trim();
            const category = document.getElementById('productCategory').value;
            const costPrice = parseFloat(document.getElementById('productCostPrice').value) || 0;
            const salePrice = parseFloat(document.getElementById('productSalePrice').value) || 0;

            if (!name || !category) return alert('Nombre y categor√≠a son requeridos');

            const product = { id: Date.now(), name, category, costPrice, salePrice, margin: salePrice - costPrice };
            data.products.push(product);
            
            document.getElementById('productName').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productCostPrice').value = '';
            document.getElementById('productSalePrice').value = '';
            
            saveData();
            renderProducts();
        }

        function renderProducts() {
            const html = data.products.map(product => `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3>${product.name}</h3>
                            <p>üè∑Ô∏è ${product.category} | üí∞ $${product.salePrice} | üìà Margen: $${product.margin}</p>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="deleteProduct(${product.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('productsList').innerHTML = html;
        }

        function deleteProduct(id) {
            if (confirm('¬øEliminar producto?')) {
                data.products = data.products.filter(p => p.id !== id);
                saveData();
                renderProducts();
            }
        }

        // Servicios
        function addService() {
            const type = document.getElementById('serviceType').value;
            const description = document.getElementById('serviceDescription').value.trim();
            const duration = parseInt(document.getElementById('serviceDuration').value) || 60;
            const price = parseFloat(document.getElementById('servicePrice').value) || 0;

            if (!type || !description) return alert('Tipo y descripci√≥n son requeridos');

            const service = { id: Date.now(), type, description, duration, price };
            data.services.push(service);
            
            document.getElementById('serviceType').value = '';
            document.getElementById('serviceDescription').value = '';
            document.getElementById('serviceDuration').value = '';
            document.getElementById('servicePrice').value = '';
            
            saveData();
            renderServices();
        }

        function renderServices() {
            const html = data.services.map(service => `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3>${service.type} - ${service.description}</h3>
                            <p>‚è±Ô∏è ${service.duration} min | üí∞ $${service.price}</p>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="deleteService(${service.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('servicesList').innerHTML = html;
        }

        function deleteService(id) {
            if (confirm('¬øEliminar servicio?')) {
                data.services = data.services.filter(s => s.id !== id);
                saveData();
                renderServices();
            }
        }

        // Ventas m√∫ltiples
        function addMultiSaleItem() {
            const container = document.getElementById('multiSaleItems');
            const itemId = Date.now();
            
            const clientOptions = data.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            const html = `
                <div class="sale-item" id="multiItem${itemId}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4>Cliente ${container.children.length + 1}</h4>
                        <button class="btn btn-danger btn-small" onclick="removeMultiSaleItem(${itemId})">üóëÔ∏è</button>
                    </div>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label>Cliente:</label>
                            <select class="multi-client" data-item="${itemId}">
                                <option value="">Seleccionar cliente</option>
                                ${clientOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Observaciones:</label>
                            <input type="text" class="multi-notes" data-item="${itemId}" placeholder="Notas espec√≠ficas">
                        </div>
                    </div>
                    <div class="items-container" id="itemsContainer${itemId}">
                        <div style="text-align: center; color: #666; padding: 20px;">
                            <p>Selecciona un cliente para agregar productos/servicios</p>
                        </div>
                    </div>
                    <button class="btn btn-small" onclick="addItemToMultiSale(${itemId})" style="margin-top: 10px;">‚ûï Agregar Producto/Servicio</button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', html);
        }

        function removeMultiSaleItem(itemId) {
            document.getElementById(`multiItem${itemId}`).remove();
        }

        function addItemToMultiSale(itemId) {
            const clientSelect = document.querySelector(`[data-item="${itemId}"].multi-client`);
            if (!clientSelect.value) return alert('Primero selecciona un cliente');

            const container = document.getElementById(`itemsContainer${itemId}`);
            const rowId = Date.now();
            
            const productOptions = data.products.map(p => `<option value="producto-${p.id}" data-price="${p.salePrice}">${p.name} - $${p.salePrice}</option>`).join('');
            const serviceOptions = data.services.map(s => `<option value="servicio-${s.id}" data-price="${s.price}">${s.type} - ${s.description} - $${s.price}</option>`).join('');
            
            if (container.children.length === 1 && container.children[0].style.textAlign === 'center') {
                container.innerHTML = '';
            }
            
            const html = `
                <div class="item-row" id="itemRow${rowId}">
                    <select class="item-select" onchange="updateItemPrice(${rowId})" style="flex: 2;">
                        <option value="">Seleccionar item</option>
                        <optgroup label="Productos">${productOptions}</optgroup>
                        <optgroup label="Servicios">${serviceOptions}</optgroup>
                    </select>
                    <input type="number" class="item-quantity" value="1" min="1" onchange="updateItemTotal(${rowId})" style="width: 80px;">
                    <input type="number" class="item-price" step="0.01" readonly style="width: 100px;">
                    <input type="number" class="item-total" step="0.01" readonly style="width: 100px;">
                    <button class="btn btn-danger btn-small" onclick="removeItemRow(${rowId})">üóëÔ∏è</button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', html);
        }

        function updateItemPrice(rowId) {
            const row = document.getElementById(`itemRow${rowId}`);
            const select = row.querySelector('.item-select');
            const priceInput = row.querySelector('.item-price');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.dataset.price) {
                priceInput.value = selectedOption.dataset.price;
                updateItemTotal(rowId);
            }
        }

        function updateItemTotal(rowId) {
            const row = document.getElementById(`itemRow${rowId}`);
            const quantity = parseFloat(row.querySelector('.item-quantity').value) || 1;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            row.querySelector('.item-total').value = (quantity * price).toFixed(2);
        }

        function removeItemRow(rowId) {
            document.getElementById(`itemRow${rowId}`).remove();
        }

        function saveMultiSale() {
            const date = document.getElementById('multiSaleDate').value;
            const frequency = document.getElementById('multiPaymentFreq').value;
            const generalNotes = document.getElementById('multiSaleNotes').value;
            
            if (!date) return alert('La fecha es requerida');
            
            const items = document.querySelectorAll('.sale-item');
            let totalSaved = 0;
            
            items.forEach(item => {
                const itemId = item.id.replace('multiItem', '');
                const clientId = item.querySelector('.multi-client').value;
                const notes = item.querySelector('.multi-notes').value;
                
                if (!clientId) return;
                
                const itemRows = item.querySelectorAll('.item-row');
                itemRows.forEach(row => {
                    const select = row.querySelector('.item-select');
                    const quantity = parseInt(row.querySelector('.item-quantity').value) || 1;
                    const total = parseFloat(row.querySelector('.item-total').value) || 0;
                    
                    if (select.value && total > 0) {
                        const [type, id] = select.value.split('-');
                        const itemData = type === 'producto' ? 
                            data.products.find(p => p.id == id) : 
                            data.services.find(s => s.id == id);
                        
                        const sale = {
                            id: Date.now() + Math.random(),
                            clientId: parseInt(clientId),
                            type,
                            itemId: parseInt(id),
                            itemName: itemData ? (itemData.name || `${itemData.type} - ${itemData.description}`) : 'Item',
                            quantity,
                            price: total / quantity,
                            total,
                            date,
                            frequency,
                            notes: `${generalNotes} ${notes}`.trim(),
                            paid: false
                        };
                        
                        data.sales.push(sale);
                        data.debts.push({
                            id: sale.id,
                            clientId: sale.clientId,
                            saleId: sale.id,
                            amount: sale.total,
                            date: sale.date,
                            frequency: sale.frequency,
                            description: `${sale.itemName} (${sale.quantity})`,
                            paid: false
                        });
                        
                        totalSaved++;
                    }
                });
            });
            
            if (totalSaved === 0) return alert('No hay items v√°lidos para guardar');
            
            saveData();
            alert(`${totalSaved} ventas guardadas exitosamente`);
            
            // Limpiar formulario
            document.getElementById('multiSaleItems').innerHTML = '';
            document.getElementById('multiSaleNotes').value = '';
            renderSales();
        }

        // Ventas individuales
        function updateClientSelects() {
            const selects = ['saleClient'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Seleccionar cliente</option>' + 
                    data.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            });
        }

        function updateSaleOptions() {
            const type = document.getElementById('saleType').value;
            const select = document.getElementById('saleItem');
            
            if (type === 'producto') {
                select.innerHTML = '<option value="">Seleccionar producto</option>' + 
                    data.products.map(p => `<option value="${p.id}" data-price="${p.salePrice}">${p.name} - ${p.salePrice}</option>`).join('');
            } else if (type === 'servicio') {
                select.innerHTML = '<option value="">Seleccionar servicio</option>' + 
                    data.services.map(s => `<option value="${s.id}" data-price="${s.price}">${s.type} - ${s.description} - ${s.price}</option>`).join('');
            } else {
                select.innerHTML = '<option value="">Seleccionar item</option>';
            }
        }

        function addSale() {
            const clientId = document.getElementById('saleClient').value;
            const type = document.getElementById('saleType').value;
            const itemId = document.getElementById('saleItem').value;
            const quantity = parseInt(document.getElementById('saleQuantity').value) || 1;
            const date = document.getElementById('saleDate').value;
            const frequency = document.getElementById('paymentFrequency').value;

            if (!clientId || !type || !itemId || !date) return alert('Todos los campos son requeridos');

            const itemData = type === 'producto' ? 
                data.products.find(p => p.id == itemId) : 
                data.services.find(s => s.id == itemId);

            if (!itemData) return alert('Item no encontrado');

            const price = type === 'producto' ? itemData.salePrice : itemData.price;
            const total = price * quantity;

            const sale = {
                id: Date.now(),
                clientId: parseInt(clientId),
                type,
                itemId: parseInt(itemId),
                itemName: itemData.name || `${itemData.type} - ${itemData.description}`,
                quantity,
                price,
                total,
                date,
                frequency,
                paid: false
            };

            data.sales.push(sale);
            data.debts.push({
                id: sale.id,
                clientId: sale.clientId,
                saleId: sale.id,
                amount: sale.total,
                date: sale.date,
                frequency: sale.frequency,
                description: `${sale.itemName} (${sale.quantity})`,
                paid: false
            });

            document.getElementById('saleClient').value = '';
            document.getElementById('saleType').value = '';
            document.getElementById('saleItem').innerHTML = '<option value="">Seleccionar item</option>';
            document.getElementById('saleQuantity').value = '1';

            saveData();
            renderSales();
        }

        function renderSales() {
            const html = data.sales.map(sale => {
                const client = data.clients.find(c => c.id === sale.clientId);
                return `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3>${client ? client.name : 'Cliente no encontrado'} - ${sale.itemName}</h3>
                                <p>üìÖ ${sale.date} | üîÑ ${sale.frequency} | üí∞ ${sale.total} | Cant: ${sale.quantity}</p>
                                <p style="color: ${sale.paid ? 'green' : 'red'};">Estado: ${sale.paid ? '‚úÖ Pagado' : '‚ùå Pendiente'}</p>
                            </div>
                            <button class="btn btn-danger btn-small" onclick="deleteSale(${sale.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('salesList').innerHTML = html;
        }

        function deleteSale(id) {
            if (confirm('¬øEliminar venta?')) {
                data.sales = data.sales.filter(s => s.id !== id);
                data.debts = data.debts.filter(d => d.saleId !== id);
                saveData();
                renderSales();
            }
        }

        // Deudas
        function renderDebts() {
            const debtsByClient = {};
            data.debts.filter(d => !d.paid).forEach(debt => {
                if (!debtsByClient[debt.clientId]) {
                    debtsByClient[debt.clientId] = { total: 0, debts: [] };
                }
                debtsByClient[debt.clientId].total += debt.amount;
                debtsByClient[debt.clientId].debts.push(debt);
            });

            const html = Object.keys(debtsByClient).map(clientId => {
                const client = data.clients.find(c => c.id == clientId);
                const { total, debts } = debtsByClient[clientId];
                
                return `
                    <div class="debt-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>${client ? client.name : 'Cliente no encontrado'}</h3>
                            <div>
                                <span style="font-size: 24px; font-weight: bold;">${total.toFixed(2)}</span>
                                <button class="btn btn-success btn-small" onclick="payAllDebts(${clientId})">Pagar Todo</button>
<button class="btn btn-small" onclick="sendDebtReminderWhatsApp(${clientId})" style="margin-left: 5px; background: #25D366;">üì± WhatsApp</button>
                            </div>

                            
                        </div>
                        ${debts.map(debt => `
                            <div style="background: rgba(255,255,255,0.2); padding: 10px; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${debt.description}</strong><br>
                                    <small>üìÖ ${debt.date} | üîÑ ${debt.frequency}</small>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 18px; font-weight: bold;">${debt.amount.toFixed(2)}</div>
                                    <button class="btn btn-success btn-small" onclick="payDebt(${debt.id})">Pagar</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');

            document.getElementById('debtsList').innerHTML = html || '<p>No hay deudas pendientes</p>';
        }

        function payDebt(debtId) {
            const debt = data.debts.find(d => d.id === debtId);
            if (debt) {
                debt.paid = true;
                const sale = data.sales.find(s => s.id === debt.saleId);
                if (sale) sale.paid = true;
                saveData();
                renderDebts();
                renderSales();
            }
        }

      function payAllDebts(clientId) {
    if (confirm('¬øMarcar todas las deudas como pagadas?')) {
        data.debts.filter(d => d.clientId == clientId && !d.paid).forEach(debt => {
            debt.paid = true;
            const sale = data.sales.find(s => s.id === debt.saleId);
            if (sale) sale.paid = true;
        });
        saveData();
        renderDebts();
        renderSales();
    }
}

// Funci√≥n para enviar recordatorio de deuda por WhatsApp
function sendDebtReminderWhatsApp(clientId) {
  // Buscar el cliente
  const client = data.clients.find(c => c.id == clientId);
  if (!client) {
    alert('Cliente no encontrado');
    return;
  }

  // Verificar que el cliente tenga tel√©fono
  if (!client.phone) {
    alert('El cliente no tiene n√∫mero de tel√©fono registrado');
    return;
  }

  // Calcular el total de deudas del cliente
  const clientDebts = data.debts.filter(d => d.clientId == clientId && !d.paid);
  const totalDebt = clientDebts.reduce((total, debt) => total + debt.amount, 0);
  if (totalDebt === 0) {
    alert('Este cliente no tiene deudas pendientes');
    return;
  }

  // Enlace para que aparezca la vista previa de Instagram
  const imageUrl = 'https://www.instagram.com/doctorpiscinassanjuan/';

  // Crear el mensaje (link primero para que genere la vista previa)
  const mensaje = `${imageUrl}

Buen d√≠a ${client.name}, le recuerdo que tiene una deuda total de $${totalDebt.toFixed(2)}.

Quedo atento ante cualquier duda e inquietud.

Para que puedas estar al d√≠a, le recuerdo mi alias: facundomancuso.mp`;

  // Limpiar el n√∫mero de tel√©fono (quitar espacios, guiones, etc.)
  let phoneNumber = client.phone.replace(/\D/g, '');

  // Si el n√∫mero no empieza con c√≥digo de pa√≠s, agregar c√≥digo argentino (54)
  if (!phoneNumber.startsWith('54') && phoneNumber.length === 10) {
    phoneNumber = '54' + phoneNumber;
  }

  // Crear la URL de WhatsApp
  const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(mensaje)}`;

  // Abrir WhatsApp en una nueva pesta√±a
  window.open(whatsappURL, '_blank');
}


        // Calendario
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = 
                new Date(year, month).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const calendar = document.getElementById('calendarGrid');
            calendar.innerHTML = '';

            // Headers
            ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'].forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                calendar.appendChild(header);
            });

            // Days
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.innerHTML = `<div>${date.getDate()}</div>`;
                
                if (date.getMonth() !== month) {
                    dayElement.style.opacity = '0.3';
                }
                
                if (date.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('today');
                }

                // Agregar eventos (servicios)
                const dateStr = date.toISOString().split('T')[0];
                const dayServices = data.sales.filter(s => s.date === dateStr && s.type === 'servicio');
                
                if (dayServices.length > 0) {
                    dayElement.classList.add('has-event');
                    dayServices.forEach(service => {
                        const client = data.clients.find(c => c.id === service.clientId);
                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'event';
                        eventDiv.textContent = client ? client.name : 'Cliente';
                        dayElement.appendChild(eventDiv);
                    });
                }

                dayElement.onclick = () => showDayEvents(dateStr, dayServices);
                calendar.appendChild(dayElement);
            }
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function showDayEvents(date, services) {
            if (services.length === 0) return;
            
            const html = services.map(service => {
                const client = data.clients.find(c => c.id === service.clientId);
                return `
                    <div class="card">
                        <h4>${service.itemName}</h4>
                        <p><strong>Cliente:</strong> ${client ? client.name : 'No encontrado'}</p>
                        <p><strong>Precio:</strong> ${service.total}</p>
                        <p><strong>Frecuencia:</strong> ${service.frequency}</p>
                        <p><strong>Estado:</strong> ${service.paid ? '‚úÖ Pagado' : '‚ùå Pendiente'}</p>
                    </div>
                `;
            }).join('');
            
            document.getElementById('eventDetails').innerHTML = html;
            document.getElementById('eventModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('eventModal').style.display = 'none';
        }

        // Dashboard
        function updateDashboard() {
            document.getElementById('totalClients').textContent = data.clients.length;
            document.getElementById('totalProducts').textContent = data.products.length;
            document.getElementById('totalServices').textContent = data.services.length;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlySales = data.sales
                .filter(s => {
                    const saleDate = new Date(s.date);
                    return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
                })
                .reduce((total, sale) => total + sale.total, 0);
            
            document.getElementById('totalSales').textContent = `${monthlySales.toFixed(2)}`;
            
            const totalDebts = data.debts
                .filter(d => !d.paid)
                .reduce((total, debt) => total + debt.amount, 0);
            
            document.getElementById('totalDebts').textContent = `${totalDebts.toFixed(2)}`;
        }

        // Exportar a Excel
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // Clientes
            const clientsWS = XLSX.utils.json_to_sheet(data.clients);
            XLSX.utils.book_append_sheet(wb, clientsWS, "Clientes");
            
            // Productos
            const productsWS = XLSX.utils.json_to_sheet(data.products);
            XLSX.utils.book_append_sheet(wb, productsWS, "Productos");
            
            // Servicios
            const servicesWS = XLSX.utils.json_to_sheet(data.services);
            XLSX.utils.book_append_sheet(wb, servicesWS, "Servicios");
            
            // Ventas con nombres de clientes
            const salesWithNames = data.sales.map(sale => {
                const client = data.clients.find(c => c.id === sale.clientId);
                return {
                    ...sale,
                    clientName: client ? client.name : 'Cliente no encontrado'
                };
            });
            const salesWS = XLSX.utils.json_to_sheet(salesWithNames);
            XLSX.utils.book_append_sheet(wb, salesWS, "Ventas");
            
            // Deudas con nombres de clientes
            const debtsWithNames = data.debts.map(debt => {
                const client = data.clients.find(c => c.id === debt.clientId);
                return {
                    ...debt,
                    clientName: client ? client.name : 'Cliente no encontrado'
                };
            });
            const debtsWS = XLSX.utils.json_to_sheet(debtsWithNames);
            XLSX.utils.book_append_sheet(wb, debtsWS, "Deudas");
            
            XLSX.writeFile(wb, `gestion_piscinas_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Renderizar todo
 function renderAll() {
    renderClients();
    renderProducts();
    renderServices();
    renderSales();
    renderDebts();
    renderAllSchedules();
    updateClientSelects();
}

        // Importar desde Excel
function importFromExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!confirm('¬øEst√°s seguro? Esto sobrescribir√° todos los datos actuales.')) {
        event.target.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const workbook = XLSX.read(e.target.result, { type: 'binary' });
            
            // Importar cada hoja
            if (workbook.SheetNames.includes('Clientes')) {
                const clientsData = XLSX.utils.sheet_to_json(workbook.Sheets['Clientes']);
                data.clients = clientsData.map(client => ({
                    id: client.id || Date.now() + Math.random(),
                    name: client.name || '',
                    phone: client.phone || '',
                    email: client.email || '',
                    address: client.address || ''
                }));
            }
            
            if (workbook.SheetNames.includes('Productos')) {
                const productsData = XLSX.utils.sheet_to_json(workbook.Sheets['Productos']);
                data.products = productsData.map(product => ({
                    id: product.id || Date.now() + Math.random(),
                    name: product.name || '',
                    category: product.category || '',
                    costPrice: parseFloat(product.costPrice) || 0,
                    salePrice: parseFloat(product.salePrice) || 0,
                    margin: parseFloat(product.margin) || 0
                }));
            }
            
            if (workbook.SheetNames.includes('Servicios')) {
                const servicesData = XLSX.utils.sheet_to_json(workbook.Sheets['Servicios']);
                data.services = servicesData.map(service => ({
                    id: service.id || Date.now() + Math.random(),
                    type: service.type || '',
                    description: service.description || '',
                    duration: parseInt(service.duration) || 60,
                    price: parseFloat(service.price) || 0
                }));
            }
            
            if (workbook.SheetNames.includes('Ventas')) {
                const salesData = XLSX.utils.sheet_to_json(workbook.Sheets['Ventas']);
                data.sales = salesData.map(sale => ({
                    id: sale.id || Date.now() + Math.random(),
                    clientId: parseInt(sale.clientId) || 0,
                    type: sale.type || '',
                    itemId: parseInt(sale.itemId) || 0,
                    itemName: sale.itemName || '',
                    quantity: parseInt(sale.quantity) || 1,
                    price: parseFloat(sale.price) || 0,
                    total: parseFloat(sale.total) || 0,
                    date: sale.date || new Date().toISOString().split('T')[0],
                    frequency: sale.frequency || 'mensual',
                    notes: sale.notes || '',
                    paid: Boolean(sale.paid)
                }));
            }
            
            if (workbook.SheetNames.includes('Deudas')) {
                const debtsData = XLSX.utils.sheet_to_json(workbook.Sheets['Deudas']);
                data.debts = debtsData.map(debt => ({
                    id: debt.id || Date.now() + Math.random(),
                    clientId: parseInt(debt.clientId) || 0,
                    saleId: debt.saleId || debt.id,
                    amount: parseFloat(debt.amount) || 0,
                    date: debt.date || new Date().toISOString().split('T')[0],
                    frequency: debt.frequency || 'mensual',
                    description: debt.description || '',
                    paid: Boolean(debt.paid)
                }));
            }
            
            // Guardar y actualizar todo
            saveData();
            renderAll();
            alert('¬°Datos importados exitosamente!');
            
            // Limpiar input
            event.target.value = '';
            
        } catch (error) {
            alert('Error al importar el archivo. Verifica que sea un Excel v√°lido.');
            console.error('Error de importaci√≥n:', error);
            event.target.value = '';
        }
    };
    
    reader.readAsBinaryString(file);
}
        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('eventModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
        // Programaci√≥n de visitas
if (!data.schedules) data.schedules = [];

function addScheduleItem(day) {
    const clientOptions = data.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    const productOptions = data.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    
    if (!clientOptions) return alert('Primero agrega clientes');
    
    const scheduleId = Date.now();
    const container = document.getElementById(`schedule-${day}`);
    
    const html = `
        <div class="schedule-item" id="schedule-${scheduleId}">
            <div style="margin-bottom: 10px;">
                <select onchange="updateScheduleProducts(${scheduleId})" style="width: 100%; padding: 5px;">
                    <option value="">Seleccionar cliente</option>
                    ${clientOptions}
                </select>
            </div>
            <div style="margin-bottom: 10px;">
                <input type="time" id="time-${scheduleId}" style="width: 100%; padding: 5px;">
            </div>
            <div id="products-${scheduleId}" style="margin-bottom: 10px;">
                <select multiple style="width: 100%; height: 80px; padding: 5px;">
                    <option value="">Seleccionar productos</option>
                    ${productOptions}
                </select>
            </div>
            <div style="display: flex; gap: 5px;">
                <button class="btn btn-success btn-small" onclick="saveScheduleItem(${scheduleId}, '${day}')">üíæ</button>
                <button class="btn btn-small" onclick="editScheduleItem(${scheduleId})">‚úèÔ∏è</button>
                <button class="btn btn-danger btn-small" onclick="deleteScheduleItem(${scheduleId})">üóëÔ∏è</button>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', html);
}

function saveScheduleItem(scheduleId, day) {
    const item = document.getElementById(`schedule-${scheduleId}`);
    const clientSelect = item.querySelector('select');
    const timeInput = item.querySelector('input[type="time"]');
    const productsSelect = item.querySelector('select[multiple]');
    
    if (!clientSelect.value || !timeInput.value) {
        return alert('Cliente y hora son requeridos');
    }
    
    const selectedProducts = Array.from(productsSelect.selectedOptions).map(opt => ({
        id: opt.value,
        name: opt.text
    }));
    
    const schedule = {
        id: scheduleId,
        day,
        clientId: parseInt(clientSelect.value),
        clientName: clientSelect.options[clientSelect.selectedIndex].text,
        time: timeInput.value,
        products: selectedProducts
    };
    
    // Remover si ya existe y agregar nuevo
    data.schedules = data.schedules.filter(s => s.id !== scheduleId);
    data.schedules.push(schedule);
    
    saveData();
    renderScheduleItem(schedule);
    updateCalendarWithSchedules();
}

function renderScheduleItem(schedule) {
    const item = document.getElementById(`schedule-${schedule.id}`);
    if (!item) return;
    
    const productsList = schedule.products.map(p => p.name).join(', ') || 'Sin productos';
    
    item.innerHTML = `
        <div style="font-weight: bold;">${schedule.clientName}</div>
        <div style="color: #666; font-size: 12px;">üïê ${schedule.time}</div>
        <div style="color: #666; font-size: 12px;">üì¶ ${productsList}</div>
        <div style="display: flex; gap: 5px; margin-top: 5px;">
            <button class="btn btn-small" onclick="editScheduleItem(${schedule.id})">‚úèÔ∏è</button>
            <button class="btn btn-danger btn-small" onclick="deleteScheduleItem(${schedule.id})">üóëÔ∏è</button>
        </div>
    `;
}

function editScheduleItem(scheduleId) {
    const schedule = data.schedules.find(s => s.id === scheduleId);
    if (!schedule) return;
    
    const item = document.getElementById(`schedule-${scheduleId}`);
    const clientOptions = data.clients.map(c => 
        `<option value="${c.id}" ${c.id === schedule.clientId ? 'selected' : ''}>${c.name}</option>`
    ).join('');
    const productOptions = data.products.map(p => 
        `<option value="${p.id}" ${schedule.products.find(sp => sp.id == p.id) ? 'selected' : ''}>${p.name}</option>`
    ).join('');
    
    item.innerHTML = `
        <div style="margin-bottom: 10px;">
            <select style="width: 100%; padding: 5px;">
                <option value="">Seleccionar cliente</option>
                ${clientOptions}
            </select>
        </div>
        <div style="margin-bottom: 10px;">
            <input type="time" value="${schedule.time}" style="width: 100%; padding: 5px;">
        </div>
        <div style="margin-bottom: 10px;">
            <select multiple style="width: 100%; height: 80px; padding: 5px;">
                <option value="">Seleccionar productos</option>
                ${productOptions}
            </select>
        </div>
        <div style="display: flex; gap: 5px;">
            <button class="btn btn-success btn-small" onclick="saveScheduleItem(${scheduleId}, '${schedule.day}')">üíæ</button>
            <button class="btn btn-danger btn-small" onclick="deleteScheduleItem(${scheduleId})">üóëÔ∏è</button>
        </div>
    `;
}

function deleteScheduleItem(scheduleId) {
    if (confirm('¬øEliminar esta visita programada?')) {
        document.getElementById(`schedule-${scheduleId}`).remove();
        data.schedules = data.schedules.filter(s => s.id !== scheduleId);
        saveData();
        updateCalendarWithSchedules();
    }
}

function renderAllSchedules() {
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    days.forEach(day => {
        const container = document.getElementById(`schedule-${day}`);
        container.innerHTML = '';
        
        const daySchedules = data.schedules.filter(s => s.day === day);
        daySchedules.forEach(schedule => {
            const html = `
                <div class="schedule-item" id="schedule-${schedule.id}">
                    <div style="font-weight: bold;">${schedule.clientName}</div>
                    <div style="color: #666; font-size: 12px;">üïê ${schedule.time}</div>
                    <div style="color: #666; font-size: 12px;">üì¶ ${schedule.products.map(p => p.name).join(', ') || 'Sin productos'}</div>
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        <button class="btn btn-small" onclick="editScheduleItem(${schedule.id})">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-small" onclick="deleteScheduleItem(${schedule.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
    });
}

function updateCalendarWithSchedules() {
    // Esta funci√≥n se llama cuando se actualiza el calendario para mostrar las visitas programadas
    renderCalendar();
}
    </script>
    
    <!-- Librer√≠a XLSX para exportar a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>